# 工場見学予約システム仕様書

## 1. システム概要

本システムは、工場見学の予約管理を行うWebアプリケーションです。一般ユーザーが工場見学の予約申込を行い、管理者が予約の承認・管理を行うことができます。

### 1.1 対象工場
- 関東リサイクル工場
- 中部リサイクル工場
- 福山リサイクル工場
- 山形選別センター
- 松本選別センター
- 西宮選別センター
- 東海選別センター
- 金沢選別センター
- 九州選別センター

## 2. 機能要件

### 2.1 フロントエンド機能

#### 2.1.1 予約状況カレンダー
- **表示形式**
  - PC版：月間カレンダー形式
  - スマホ版：リスト形式（スクロール可能）
- **予約状況表示**
  - ◯：予約可能（クリック可）
  - △：調整中（クリック不可）
  - －：見学不可（クリック不可）
- **期間選択**：今月〜12ヶ月先まで選択可能
- **工場切り替え**：URLパラメータで工場を識別

#### 2.1.2 時間帯選択モーダル
- 見学時間の選択（60分/90分）※工場により異なる
- 時間帯の選択
  - AMまたはPMのみのパターン
  - 60分・90分で分かれるパターン
- 選択後、見学者情報入力フォームへ遷移

#### 2.1.3 予約フォーム（見学者情報入力）
- **共通入力項目**
  - 見学日（カレンダーから引き継ぎ）
  - 見学時間（カレンダーから引き継ぎ）
  - 見学時間帯（カレンダーから引き継ぎ）
  - 申込者様氏名（ふりがな）
  - 申込者様は旅行会社の方ですか？（はい/いいえ）
  - 申込者様住所（郵便番号自動入力機能付き）
  - 申込者様電話番号
  - 当日連絡先（携帯番号）
  - 申込者様メールアドレス
  - ご利用の交通機関（車/貸切バス/路線バス/タクシー/その他）
  - 台数（交通機関が車等の場合）
  - 見学目的

- **旅行会社の場合の追加項目**
  - 旅行会社名
  - 旅行会社電話番号
  - 旅行会社住所
  - 旅行会社FAX番号
  - 担当者携帯番号
  - 担当者メールアドレス

- **見学者様の分類別入力項目**
  1. **小学校・中学校・大学**
     - 学校・団体名（ふりがな）
     - 代表者様氏名（ふりがな）
     - 学年
     - クラス数
     - 見学者様人数（児童・生徒）
     - 見学者様人数（引率）

  2. **個人（大学生・高校生のリクルート）**
     - 学校名
     - 学部
     - 学年
     - 見学者様人数
     - 同行者情報（人数分）

  3. **個人・親子見学・ご家族など / 企業（研修など）/ 自治体主体ツアーなど / その他（グループ・団体）**
     - 会社・団体名（ふりがな）
     - 見学者様人数（大人）
     - 見学者様人数（子ども）
     - 学年（子どもがいる場合）

- **バリデーション**
  - 必須項目チェック
  - 予約可能人数チェック（リアルタイム）
  - エラーメッセージ表示

#### 2.1.4 入力内容確認画面
- 入力した全項目の表示
- 内容修正ボタン（入力画面へ戻る）
- 送信ボタン

#### 2.1.5 予約完了画面
- 完了メッセージ表示
- 予約内容印刷機能
- TOPへ戻るボタン

### 2.2 管理画面機能

#### 2.2.1 予約一覧
- **表示項目**
  - 予約番号
  - 予約者
  - 予約日時
  - 電話番号
  - 予約タイプ
  - ステータス
- **機能**
  - 絞り込み検索（予約番号/予約日/予約時間/予約ステータス）
  - CSV出力
  - ページネーション
  - ソート機能（各項目で昇順/降順）
  - 工場アカウントは自工場の予約のみ表示

#### 2.2.2 予約追加・編集
- フロントエンドと同様の入力項目
- 予約ステータス選択
  - 新規受付
  - 確認中
  - 承認
  - 否認
  - キャンセル
- 返信メール作成機能（確認中の場合）
- 管理画面では人数制限チェックなし

#### 2.2.3 予約返信メール
- 予約に紐づいたメールアドレスが自動設定
- テンプレート選択（承認用/否認用）
- 件名・本文編集
- 送信時にステータス自動更新

#### 2.2.4 予約カレンダー
- 工場別カレンダー表示
- 見学不可日設定（AM/PM別）
- 土日祝はデフォルトで見学不可
- 予約可能人数表示
- 月移動機能（過去月は非表示）

#### 2.2.5 ユーザー編集
- **基本設定**
  - WordPress標準のユーザー編集画面を拡張
  - 管理者アカウントのみアクセス・編集可能
  - 工場アカウントは自身の情報のみ閲覧可能（編集不可）

- **工場アカウント設定**
  - **工場選択**
    - ドロップダウンリストから工場を選択
    - 選択可能な工場：
      - 関東リサイクル工場
      - 中部リサイクル工場
      - 福山リサイクル工場
      - 山形選別センター
      - 松本選別センター
      - 西宮選別センター
      - 東海選別センター
      - 金沢選別センター
      - 九州選別センター
    - 既に他のユーザーに紐付けられている工場は選択不可（リストに表示されない）
    - 工場アカウントでログイン時は自身の工場が自動選択され、変更不可

  - **予約可能人数設定**
    - 数値入力フィールド
    - デフォルト値：50名
    - フロントエンドの予約フォームで人数制限チェックに使用
    - 1〜999の範囲で設定可能

  - **見学時間帯表示**
    - 選択された工場の見学可能時間帯を表示（読み取り専用）
    - AM・PMパターンの場合の表示例：
      ```
      AM
      9:00 ~ 10:00
      9:30 ~ 10:30
      11:00 ~ 12:00
      
      PM
      14:00 ~ 15:00
      14:30 ~ 15:30
      16:00 ~ 17:00
      ```
    - 60分・90分パターンの場合の表示例：
      ```
      60分
      AM
      9:00 ~ 10:00
      9:30 ~ 10:30
      11:00 ~ 12:00
      
      PM
      14:00 ~ 15:00
      14:30 ~ 15:30
      16:00 ~ 17:00
      
      90分
      AM
      9:00 ~ 10:30
      9:30 ~ 11:00
      10:00 ~ 11:30
      10:30 ~ 12:00
      
      PM
      13:00 ~ 14:30
      13:30 ~ 15:00
      14:00 ~ 15:30
      14:30 ~ 16:00
      15:00 ~ 16:30
      ```

- **WordPress標準項目**
  - ユーザー名（変更不可）
  - メールアドレス
  - 名前（姓・名）
  - ニックネーム
  - ブログ上の表示名
  - ウェブサイト
  - プロフィール情報
  - 新しいパスワード
  - パスワード確認

- **権限設定**
  - 管理者：全機能へのアクセス権限
  - 工場管理者：自工場の予約管理権限
  - 購読者：権限なし（通常は使用しない）

- **保存処理**
  - 「プロフィールを更新」ボタンで保存
  - 工場の紐付けを変更した場合、以前の工場との紐付けは解除
  - 予約可能人数の変更は即座に反映

### 2.3 見学時間帯管理システム

#### 2.3.1 時間帯管理モード
工場ごとに以下の2つの管理方式から選択可能：

##### AM・PMパターン
- **概要**
  - 見学時間帯を「午前（AM）」と「午後（PM）」の2区分でシンプルに管理
  - AM・PMの内部には固定の見学時間帯を定義（例：9:00〜10:00、10:30〜11:30）
  - ユーザー側はAMまたはPM単位での予約可否を設定・管理

- **仕様**
  - 管理画面で各日付ごとに「AM」「PM」の可否を設定可能
  - AMまたはPMを不可にすると、その日の午前・午後の見学全体が予約不可
  - 内部の詳細時間帯は表示のみで編集不可
  - **予約制限**: 午前または午後のいずれかの時間帯に1枠でも予約が入った場合、その時間帯（AM/PM）全体が予約不可となる

- **利用シーン**
  - 工場見学の時間割が午前・午後で固定されており、細かい時間の選択が不要な場合

##### 60分・90分パターン
- **概要**
  - 見学時間を「60分コース」と「90分コース」に分けて管理
  - 各コース内で複数の具体的な時間帯を管理
  - ユーザーは希望のコースと時間帯を選択可能

- **仕様**
  - 管理画面で60分・90分それぞれの時間帯ごとに予約可否を設定可能
  - 工場ごとに設定された開始・終了時間を管理し、フロントエンドで表示
  - AM・PM区分の中で60分・90分の時間帯が並列に表示
  - **予約制限**: 60分または90分コースの午前・午後のいずれかの時間帯に1枠でも予約が入った場合、その時間帯（60分AM/60分PM/90分AM/90分PM）全体が予約不可となる

- **利用シーン**
  - 見学の所要時間にバリエーションがあり、工場側でコースごとに枠を管理したい場合

#### 2.3.2 工場ごとの設定
- **時間帯管理モード設定**
  - 管理画面の工場設定で以下から選択：
    - AM・PMのみ
    - 60分・90分コース
  - 設定は`timeslot_mode`カラムに保存
  - フロントエンドと管理画面の表示に自動反映

- **時間帯の例**
  - AM・PMパターンの例：
    - AM: 9:00〜10:00、9:30〜10:30、11:00〜12:00
    - PM: 14:00〜15:00、14:30〜15:30、16:00〜17:00
  
  - 60分・90分パターンの例：
    - 60分コース: 9:00〜10:00、9:30〜10:30、11:00〜12:00、14:00〜15:00、14:30〜15:30、16:00〜17:00
    - 90分コース: 9:00〜10:30、9:30〜11:00、10:00〜11:30、10:30〜12:00、13:00〜14:30、13:30〜15:00、14:00〜15:30、14:30〜16:00、15:00〜16:30

## 3. 非機能要件

### 3.1 アクセス権限
- **管理者アカウント**：全機能へのアクセス可能
- **工場アカウント**：自工場の情報のみアクセス可能
- **一般ユーザー**：フロントエンド機能のみ利用可能

### 3.2 メール送信
- 予約申込時：管理者とユーザーへ自動送信
- 予約承認/否認時：ユーザー、管理者（控え）、工場アカウント（控え）へ送信

### 3.3 データ連携
- 予約完了時、該当時間帯を自動的に見学不可に設定
- 郵便番号から住所自動入力

### 3.4 予約制限ルール
- **AM・PMパターン**: 午前または午後のいずれかの時間帯に1枠でも予約が入った場合、その時間帯（AM/PM）全体が予約不可
- **60分・90分パターン**: 60分または90分コースの午前・午後のいずれかの時間帯に1枠でも予約が入った場合、その時間帯（60分AM/60分PM/90分AM/90分PM）全体が予約不可
- **同時予約防止**: 同一工場の同一日において、複数の予約が同時に成立することはない
- **予約優先**: 先に予約申込を完了した予約者が優先される

### 3.5 レスポンシブ対応
- PC版とスマホ版でUIを最適化
- スマホ版カレンダーはスクロール可能なリスト形式

## 4. データ構造

### 4.1 データベーステーブル設計

#### 4.1.1 wp_users テーブル（WordPress標準を拡張）
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|---------|----------|------|--------------|------|
| ID | bigint | PRIMARY KEY, AUTO_INCREMENT | - | ユーザーID |
| user_login | varchar(60) | NOT NULL | - | ログイン名 |
| user_pass | varchar(255) | NOT NULL | - | パスワード（ハッシュ化） |
| user_nicename | varchar(50) | NOT NULL | - | ユーザー表示名（URL用） |
| user_email | varchar(100) | NOT NULL | - | メールアドレス |
| user_url | varchar(100) | NOT NULL | '' | ウェブサイトURL |
| user_registered | datetime | NOT NULL | 0000-00-00 00:00:00 | 登録日時 |
| user_activation_key | varchar(255) | NOT NULL | '' | アクティベーションキー |
| user_status | int | NOT NULL | 0 | ユーザーステータス |
| display_name | varchar(250) | NOT NULL | - | 表示名 |

#### 4.1.2 wp_factories テーブル
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|---------|----------|------|--------------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | - | 工場ID |
| name | varchar(255) | NOT NULL | - | 工場名 |
| capacity | int | NOT NULL | 50 | 予約可能人数 |
| manager_user_id | bigint | - | NULL | 管理ユーザーID（外部キー） |
| timeslot_mode | varchar(20) | NOT NULL | 'am_pm_only' | 時間帯管理モード |
| created_at | datetime | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | datetime | NOT NULL ON UPDATE | CURRENT_TIMESTAMP | 更新日時 |

#### 4.1.3 wp_unavailable_days テーブル
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|---------|----------|------|--------------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | - | ID |
| factory_id | bigint | NOT NULL | - | 工場ID（外部キー） |
| date | date | NOT NULL | - | 日付 |
| am_unavailable | tinyint(1) | NOT NULL | 0 | AM見学不可フラグ |
| pm_unavailable | tinyint(1) | NOT NULL | 0 | PM見学不可フラグ |
| created_at | datetime | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | datetime | NOT NULL ON UPDATE | CURRENT_TIMESTAMP | 更新日時 |

#### 4.1.4 wp_reservations テーブル（設計案）
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|---------|----------|------|--------------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | - | 予約番号 |
| factory_id | bigint | NOT NULL | - | 工場ID（外部キー） |
| visit_date | date | NOT NULL | - | 見学日 |
| visit_duration | int | NOT NULL | 60 | 見学時間（分） |
| time_slot | varchar(20) | NOT NULL | - | 時間帯 |
| status | varchar(20) | NOT NULL | 'new' | 予約ステータス |
| visitor_type | varchar(50) | NOT NULL | - | 見学者分類 |
| is_travel_agency | tinyint(1) | NOT NULL | 0 | 旅行会社フラグ |
| applicant_name | varchar(255) | NOT NULL | - | 申込者氏名 |
| applicant_kana | varchar(255) | NOT NULL | - | 申込者氏名（ふりがな） |
| applicant_email | varchar(255) | NOT NULL | - | 申込者メールアドレス |
| applicant_phone | varchar(20) | NOT NULL | - | 申込者電話番号 |
| applicant_mobile | varchar(20) | NOT NULL | - | 当日連絡先 |
| applicant_postal_code | varchar(10) | - | - | 申込者郵便番号 |
| applicant_prefecture | varchar(50) | - | - | 申込者都道府県 |
| applicant_city | varchar(255) | - | - | 申込者市町村 |
| applicant_address | varchar(255) | - | - | 申込者番地 |
| organization_name | varchar(255) | - | - | 組織名 |
| organization_kana | varchar(255) | - | - | 組織名（ふりがな） |
| visitor_count_adult | int | NOT NULL | 0 | 見学者人数（大人） |
| visitor_count_child | int | NOT NULL | 0 | 見学者人数（子ども） |
| transportation | varchar(50) | NOT NULL | - | 交通機関 |
| vehicle_count | int | - | - | 台数 |
| visit_purpose | text | - | - | 見学目的 |
| created_at | datetime | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | datetime | NOT NULL ON UPDATE | CURRENT_TIMESTAMP | 更新日時 |

#### 4.1.5 wp_reservation_details テーブル（設計案）
| カラム名 | データ型 | 制約 | デフォルト値 | 説明 |
|---------|----------|------|--------------|------|
| id | bigint | PRIMARY KEY, AUTO_INCREMENT | - | ID |
| reservation_id | bigint | NOT NULL | - | 予約ID（外部キー） |
| field_name | varchar(100) | NOT NULL | - | フィールド名 |
| field_value | text | - | - | フィールド値 |
| created_at | datetime | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |

### 4.2 予約データ
- 予約番号（連番）
- 見学工場
- 見学日
- 見学時間（60分/90分）
- 見学時間帯
- 申込者情報
- 見学者情報
- 予約ステータス
- 作成日時
- 更新日時

### 4.2 工場マスタ
- 工場ID
- 工場名
- 予約可能人数
- 見学時間帯設定
- 時間帯管理モード（timeslot_mode）
  - am_pm_only: AM・PMパターン
  - duration_based: 60分・90分パターン

### 4.3 ユーザーマスタ
- ユーザーID
- ユーザー名
- 権限（管理者/工場アカウント）
- 紐付け工場ID

## 5. 画面遷移

### 5.1 フロントエンド
1. TOP → 予約状況カレンダー
2. 予約状況カレンダー → 時間帯選択モーダル
3. 時間帯選択 → 予約フォーム
4. 予約フォーム → 入力内容確認
5. 入力内容確認 → 予約完了

### 5.2 管理画面
1. ダッシュボード → 各機能画面
2. 予約一覧 → 予約編集
3. 予約編集 → 返信メール作成
4. 各画面間は相互に遷移可能

## 6. 技術仕様

### 6.1 プラットフォーム
- WordPress ベース
- カスタム投稿タイプとして実装

### 6.2 対応ブラウザ
- 最新版の主要ブラウザ（Chrome、Firefox、Safari、Edge）
- スマートフォンブラウザ対応

### 6.3 セキュリティ
- ログイン認証必須（管理画面）
- CSRF対策
- XSS対策
- SQLインジェクション対策