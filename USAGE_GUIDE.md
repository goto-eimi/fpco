# 工場見学予約システム使用ガイド

## セットアップ手順

### 1. データベーステーブルの作成
```sql
-- phpMyAdminまたはデータベース管理ツールで以下のSQLを実行
-- database_setup.sql の内容を実行してください
```

### 2. WordPressページの作成
WordPress管理画面で以下の4つのページを作成してください：

1. **予約フォーム**
   - タイトル: 「予約フォーム」
   - スラッグ: `reservation-form`
   - テンプレート: 「予約フォーム」

2. **入力確認**
   - タイトル: 「予約内容確認」
   - スラッグ: `reservation-confirm`
   - テンプレート: 「予約フォーム確認」

3. **予約完了**
   - タイトル: 「予約完了」
   - スラッグ: `reservation-complete`
   - テンプレート: 「予約完了」

4. **印刷ページ**
   - タイトル: 「予約内容印刷」
   - スラッグ: `reservation-print`
   - テンプレート: 「予約内容印刷」

### 3. パーマリンク設定
- WordPress管理画面 → 設定 → パーマリンク
- 「投稿名」を選択して保存

## 使用方法

### フロー1: カレンダーからの予約
1. **カレンダーページにアクセス**
   - 「予約状況カレンダー」テンプレートが設定されたページ

2. **日付・時間帯の選択**
   - ○マークの時間帯をクリック
   - 60分・90分を選択
   - 具体的な時間帯を選択

3. **自動遷移**
   - 選択完了後、自動で予約フォームに遷移
   - URLパラメータで工場・日付・時間帯が引き継がれる

### フロー2: 直接予約フォームアクセス
URLに必要なパラメータを付けてアクセス：
```
/reservation-form/?factory=1&date=2025-06-01&timeslot=am-60-1
```

## パラメータ説明

### 工場ID (factory)
- 1: 関東リサイクル
- 2: 中部リサイクル  
- 3: 福山リサイクル
- 4: 山形選別センター
- 5: 松本選別センター
- 6: 西宮選別センター
- 7: 東海選別センター
- 8: 金沢選別センター
- 9: 九州選別センター

### 日付 (date)
形式: YYYY-MM-DD
例: 2025-06-01

### 時間帯 (timeslot)
- am-60-1: 午前9:00〜10:00（60分）
- am-60-2: 午前10:30〜11:30（60分）
- am-90-1: 午前9:00〜10:30（90分）
- am-90-2: 午前10:00〜11:30（90分）
- pm-60-1: 午後14:00〜15:00（60分）
- pm-60-2: 午後15:30〜16:30（60分）
- pm-90-1: 午後14:00〜15:30（90分）
- pm-90-2: 午後15:00〜16:30（90分）

## 予約フォーム機能

### 自動表示・非表示
- **旅行会社情報**: 「はい」選択時に表示
- **交通機関詳細**: 「その他」選択時に表示  
- **台数入力**: 「車」「貸切バス」選択時に表示
- **見学者詳細**: 分類選択に応じて動的表示

### バリデーション
- **リアルタイムチェック**: 入力時・フォーカス移動時
- **必須項目**: 赤枠とエラーメッセージ表示
- **人数制限**: 50名を超えると警告・送信ボタン無効化
- **形式チェック**: メール・電話番号・郵便番号

### 郵便番号検索
- 郵便番号入力後「住所検索」ボタンクリック
- 都道府県・市区町村・番地を自動入力（デモ実装）

## 画面遷移フロー

```
カレンダー画面
    ↓ 時間帯選択
予約フォーム
    ↓ 入力完了
入力確認画面  
    ↓ 送信
予約完了画面
    ↓ 印刷ボタン
印刷画面（新しいタブ）
```

## トラブルシューティング

### 「ページが見つかりません」エラー
1. WordPressページが正しく作成されているか確認
2. スラッグが正しく設定されているか確認
3. パーマリンクを再保存（設定→パーマリンク→保存）

### テンプレートが適用されない
1. テンプレートファイルがテーマフォルダに存在するか確認
2. ファイル名が正しいか確認
3. Template Nameコメントが正しいか確認

### フォーム送信エラー
1. データベーステーブルが作成されているか確認
2. WordPressページ「reservation-confirm」が存在するか確認
3. フォームのaction属性がWordPressページのURLと一致するか確認

### JavaScriptエラー
1. ブラウザのデベロッパーツールでエラーを確認
2. jQueryが読み込まれているか確認
3. JavaScriptファイルが正しいパスにあるか確認

## 開発者向け情報

### カスタマイズポイント
- フォーム項目追加: `page-reservation-form.php` と `reservation-form.js`
- バリデーションルール: `reservation-form.js` の `validateField()`
- メールテンプレート: `page-reservation-complete.php` の送信関数
- 印刷レイアウト: `page-reservation-print.php`

### データベース構造
- メインテーブル: `wp_reservations`
- 旅行会社テーブル: `wp_reservation_agencies`
- 全データがJSONでも保存される（`form_data`カラム）

### セキュリティ考慮事項
- 全入力データのサニタイゼーション実装済み
- SQLインジェクション対策（WordPressのwpdb使用）
- CSRF対策（WordPressのnonce機能と統合可能）